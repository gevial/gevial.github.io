---
layout: post
title: Отладка ошибки 502, вызываемой падением PHP-сценария
modified: 2015-06-19
tags: [php, troubleshooting, apache]
---
Ошибка 502 является, пожалуй, наиболее сложной для отладки.

Однако, если ошибка вызывана аварийным завершением работы PHP-сценария, найти причину можно достаточно быстро. На помощь придёт `gdb`.

Первое, что нам нужно, это настроит сбор core-дампов в веб-сервере. Имея файл (предположим, что его имя core), загрузим его в `gdb`:

```
# gdb /opt/apache/bin/httpd core
GNU gdb 6.8
Copyright (C) 2008 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-pc-linux-gnu"...
(no debugging symbols found)

warning: Can't read pathname for load map: Input/output error.
Reading symbols from /lib64/libm.so.6...(no debugging symbols found)...done.
Loaded symbols for /lib/libm.so.6
Reading symbols from /lib64/libcrypt.so.1...(no debugging symbols found)...done.
...

Core was generated by `/opt/apache/bin/httpd -f /etc/opt/apache/config/labirintum.conf'.
Program terminated with signal 11, Segmentation fault.
[New process 30762]
#0  0x00007f31f727649b in memcpy () from /lib/libc.so.6
(gdb)
```

Выводим backtrace командой `bt`:

```
#0  0x00007f31f727649b in memcpy () from /lib/libc.so.6
#1  0x00007f31f6048f94 in zend_prepare_string_for_scanning (str=<value optimized out>, filename=0x7f31f65e55bf "")
    at Zend/zend_language_scanner.l:447
#2  0x00007f31f600342f in zif_token_get_all (ht=<value optimized out>, return_value=0x33cc2d0,
    return_value_ptr=<value optimized out>, this_ptr=<value optimized out>, return_value_used=<value optimized out>)
    at /usr/src/php5.3/ext/tokenizer/tokenizer.c:177
#3  0x00007f31f609de63 in zend_do_fcall_common_helper_SPEC (execute_data=0x7f31e2fc5dc0)
    at /usr/src/php5.3/Zend/zend_vm_execute.h:320
#4  0x00007f31f609d023 in execute (op_array=0x33e2c08) at /usr/src/php5.3/Zend/zend_vm_execute.h:107
#5  0x00007f31f124faa6 in zend_oe () from /usr/local/lib/php/extensions/ZendGuardLoader.so
#6  0x00007f31f609d98e in zend_do_fcall_common_helper_SPEC (execute_data=0x7f31e2fc58d8)
    at /usr/src/php5.3/Zend/zend_vm_execute.h:344
#7  0x00007f31f609d023 in execute (op_array=0x33e5738) at /usr/src/php5.3/Zend/zend_vm_execute.h:107
#8  0x00007f31f124faa6 in zend_oe () from /usr/local/lib/php/extensions/ZendGuardLoader.so
#9  0x00007f31f609d98e in zend_do_fcall_common_helper_SPEC (execute_data=0x7f31e2fc3118)
    at /usr/src/php5.3/Zend/zend_vm_execute.h:344
#10 0x00007f31f609d023 in execute (op_array=0x1dae780) at /usr/src/php5.3/Zend/zend_vm_execute.h:107
#11 0x00007f31f124faa6 in zend_oe () from /usr/local/lib/php/extensions/ZendGuardLoader.so
#12 0x00007f31f609d98e in zend_do_fcall_common_helper_SPEC (execute_data=0x7f31e2fc2f90)
    at /usr/src/php5.3/Zend/zend_vm_execute.h:344
#13 0x00007f31f609d023 in execute (op_array=0x25445c0) at /usr/src/php5.3/Zend/zend_vm_execute.h:107
#14 0x00007f31f124faa6 in zend_oe () from /usr/local/lib/php/extensions/ZendGuardLoader.so
#15 0x00007f31f609d98e in zend_do_fcall_common_helper_SPEC (execute_data=0x7f31e2fc20a0)
    at /usr/src/php5.3/Zend/zend_vm_execute.h:344
...
```

Нам нужно перейти в четвёртый фрейм, соответствующий функции `execute()`, в которой происходит непосредственное исполнение интерпретатором сценария.

```
(gdb) frame 4
#4  0x00007f31f609d023 in execute (op_array=0x33e2c08) at /usr/src/php5.3/Zend/zend_vm_execute.h:107
107			if ((ret = EX(opline)->handler(execute_data TSRMLS_CC)) > 0) {
```

Далее можно узнать имя файла и имя функции, в которой возникает Segmentation Fault.

```
(gdb) print op_array.function_name
$1 = 0x33e37a8 "getPhpChunks"
(gdb) print op_array.filename
$2 = 0x33828b8 "/home/j/johndoe/beta.example.com/public_html/bitrix/modules/main/classes/general/php_parser.php"
(gdb)
```

Итак, теперь мы знаем имя файла, функции, и даже строку, в которой происходит падение интерпретатора.
