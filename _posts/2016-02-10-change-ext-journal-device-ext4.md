---
title: Смена устройства, хранящего внешний журнал ext4
tags: [storage, FS, ext4]
---
Недавно столкнулся со следующей ситуацией.

Есть файловая система ext4 на 22 Тб. Настроили для неё размещение журнала на отдельной SSD, указали опцию монтирования `journal_async_commit`.
Спустя сутки ФС внезапно стала read-only. Оказалось, диск, на котором размещался журнал, был извлечён из системы с помощью `MegaCli`.
Отмонтировать ФС не удавалось, umount "висел". Были вынуждены перезагрузить сервер через reset.

После загрузки сменились major и minor номера всех блочных устройств, они стали такими:

```
# cat /proc/partitions
major minor  #blocks  name

   8       16  233897984 sdb
   8       17  233896960 sdb1
   8       32  175276032 sdc
   8        0 23437770752 sda
   8        1 23437768704 sda1
   8       48   97685784 sdd
   8       49   97684480 sdd1
#
```

ФС не монтировалась, несмотря на то, что при подключении внешнего журнала был указан UUID. Примонтировали ФС только со сменой устройства журнала:

```
mount -t ext4 -o journal_dev=$(stat -c "0x%t%T" /dev/sdc) /dev/sda1 /var/spool/maildir
```

Трудность была в том, что в мануале `mount` не указано, в каком формате необходимо передавать аргумент опции `journal_dev`. Информацию я нашёл лишь где-то в списках рассылки.

Стоит отметить, что в современных версиях `mount` есть опция `journal_path`, которая позволяет указать просто путь к устройству. Но в Ubuntu 12.04 этой опции в `mount` нет.

После успешного монтирования мы опять выполнили `umount`, чтобы "прогнать" `e2fsck`. После ФС успешно примонтировалась просто по `mount -a`.
